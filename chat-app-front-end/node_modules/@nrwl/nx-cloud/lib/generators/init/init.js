"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.schematic = exports.generator = void 0;
const fs_1 = require("fs");
const rxjs_1 = require("rxjs");
function updateNxJson(json, token) {
    json.tasksRunnerOptions = {
        default: {
            runner: '@nrwl/nx-cloud',
            options: {
                accessToken: token,
                cacheableOperations: ['build', 'test', 'lint', 'e2e'],
                canTrackAnalytics: false,
                showUsageWarnings: true,
            },
        },
    };
    if (process.env.NRWL_API) {
        json.tasksRunnerOptions.default.options.url = process.env.NRWL_API;
    }
}
function updateNxJsonUsingDevkit(host, token) {
    require('@nrwl/devkit').updateJson(host, 'nx.json', (json) => {
        updateNxJson(json, token);
        return json;
    });
}
function updateNxJsonUsingNrwlWorkspace(token) {
    return require('@nrwl/workspace').updateJsonInTree('nx.json', (json) => {
        updateNxJson(json, token);
        return json;
    });
}
function readNpmScope() {
    const nxJson = JSON.parse(fs_1.readFileSync('nx.json').toString());
    return nxJson.npmScope;
}
function createNxCloudWorkspace(workspaceName) {
    return __awaiter(this, void 0, void 0, function* () {
        const API = process.env.NRWL_API || `https://api.nrwl.io`;
        const response = yield require('axios').post(`${API}/nx-cloud/create-org-and-workspace`, {
            workspaceName,
        });
        if (response.data.message) {
            throw new Error(response.data.message);
        }
        return response.data;
    });
}
function printMessage(url) {
    const output = require('@nrwl/workspace/src/utils/output').output;
    let host = 'nx.app';
    try {
        host = new (require('url').URL)(url).host;
    }
    catch (e) { }
    output.note({
        title: `Nx Cloud has been enabled`,
        bodyLines: [
            `Your workspace is currently public. Anybody with code access can view the workspace on ${host}. `,
            `You can connect the workspace to your Nx Cloud account at ${url}. (You can do this later.)`,
        ],
    });
}
function printMessageTaskExecutor(url) {
    return {
        name: 'NxCloudPrintMessage',
        create: () => {
            return Promise.resolve(() => {
                return new rxjs_1.Observable((obs) => {
                    printMessage(url);
                    obs.next();
                    obs.complete();
                });
            });
        },
    };
}
function generator(host) {
    return __awaiter(this, void 0, void 0, function* () {
        const r = yield createNxCloudWorkspace(readNpmScope());
        updateNxJsonUsingDevkit(host, r.token);
        return () => printMessage(r.url);
    });
}
exports.generator = generator;
function schematic() {
    return () => __awaiter(this, void 0, void 0, function* () {
        const r = yield createNxCloudWorkspace(readNpmScope());
        return (host, context) => {
            const engineHost = context.engine.workflow.engineHost;
            engineHost.registerTaskExecutor(printMessageTaskExecutor(r.url));
            context.addTask({
                toConfiguration() {
                    return { name: 'NxCloudPrintMessage' };
                },
            });
            updateNxJsonUsingNrwlWorkspace(r.token)(host, context);
        };
    });
}
exports.schematic = schematic;
//# sourceMappingURL=init.js.map